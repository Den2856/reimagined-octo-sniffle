import dotenv from 'dotenv'
dotenv.config()

import express, { Request, Response, NextFunction } from 'express'
import mongoose from 'mongoose'
import cors from 'cors'
import cookieParser from 'cookie-parser'

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤–∞—à–∏ —Ä–æ—É—Ç—ã
import authRouter from './routes/auth'
import placesRouter from './routes/places'
import tourTypesRouter from './routes/tourType'
import tripRouter from './routes/trip'
import reviewRouter from './routes/rewiew'

const app = express()
const CLIENT_URL = process.env.CLIENT_URL || 'http://localhost:5173'

// 1) JSON-–ø–∞—Ä—Å–µ—Ä –¥–ª—è body
app.use(express.json())

// 2) Cookie-–ø–∞—Ä—Å–µ—Ä (–µ—Å–ª–∏ –≤—ã –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ)
app.use(cookieParser())

// 3) CORS —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º origin –∏ credentials: true
app.use(cors({
  origin: CLIENT_URL,
  credentials: true,
  methods: ['GET','POST','PUT','DELETE','OPTIONS'],
  allowedHeaders: ['Content-Type','Authorization'],
}))

// 3) –ü–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞
app.get('/', (_req: Request, res: Response) => {
  res.send('‚úÖ API is running')
})

// 4) –ú–æ–Ω—Ç–∏—Ä—É–µ–º —Ä–æ—É—Ç—ã
app.use('/api/auth', authRouter)
app.use('/api/places', placesRouter)
app.use('/api/tour-types', tourTypesRouter)
app.use('/api/trips', tripRouter)
app.use('/api/reviews', reviewRouter)

// 5) –ì–ª–æ–±–∞–ª—å–Ω—ã–π error‚Äêhandler
app.use((
  err: any,
  _req: Request,
  res: Response,
  _next: NextFunction
) => {
  console.error(err)
  res.status(err.status || 500).json({ message: err.message || 'Server Error' })
})

// 6) –ü–æ–¥–∫–ª—é—á–∞–µ–º Mongo –∏ —Å—Ç–∞—Ä—Ç—É–µ–º
mongoose
  .connect(process.env.MONGO_URI!)
  .then(() => {
    console.log('‚úÖ MongoDB connected')
    const port = process.env.PORT || 4000
    app.listen(port, () => {
      console.log(`üöÄ Server listening on port ${port}`)
    })
  })
  .catch(err => {
    console.error('‚ùå MongoDB connection error:', err)
    process.exit(1)
  })
